#!/bin/bash

echo "ğŸ” Testando Sistema PontualIoT..."

echo ""
echo "ğŸ“Š 1. Testando API Core (localhost:8082):"
curl -s http://localhost:8082/actuator/health && echo " âœ… Health OK" || echo " âŒ Health failed"
curl -s http://localhost:8082/actuator/prometheus | head -5 && echo " âœ… Metrics OK" || echo " âŒ Metrics failed"

echo ""
echo "ğŸ“ˆ 2. Testando Prometheus (localhost:9090):"
curl -s "http://localhost:9090/api/v1/query?query=up" | grep -o '"value":\[[^]]*\]' && echo " âœ… Prometheus OK" || echo " âŒ Prometheus failed"

echo ""
echo "ğŸ“Š 3. Testando Grafana (localhost:3000):"
curl -s http://localhost:3000/api/health | grep -o '"database":"ok"' && echo " âœ… Grafana OK" || echo " âŒ Grafana failed"

echo ""
echo "ğŸ“¡ 4. Testando MQTT (localhost:1883):"
timeout 2 mosquitto_pub -h localhost -p 1883 -t "test" -m "hello" && echo " âœ… MQTT OK" || echo " âŒ MQTT failed"

echo ""
echo "ğŸ¯ Como usar Prometheus e Grafana:"
echo ""
echo "ğŸ“ˆ PROMETHEUS (http://localhost:9090):"
echo "  â€¢ Queries Ãºteis:"
echo "    - up (status dos serviÃ§os)"
echo "    - attendance_records_total (total de registros)"
echo "    - iot_devices_active (dispositivos ativos)"
echo "    - http_request_duration_seconds (performance)"
echo ""
echo "ğŸ“Š GRAFANA (http://localhost:3000):"
echo "  â€¢ Login: admin/admin"
echo "  â€¢ Dashboard jÃ¡ configurado: 'PontualIoT - Real Time Monitoring'"
echo "  â€¢ Para criar novo dashboard:"
echo "    1. + â†’ Dashboard"
echo "    2. Add Panel"
echo "    3. Query: attendance_records_total"
echo "    4. Visualization: Stat/Graph"
echo ""